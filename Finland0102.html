import React, { useState, useEffect, useRef } from 'react';
import { Map, MapPin, Navigation, Snowflake, ShoppingBag, Utensils, Info, Check, Camera } from 'lucide-react';

const FinlandTripApp = () => {
  const [activeTab, setActiveTab] = useState('itinerary');
  const [selectedDay, setSelectedDay] = useState(null);
  const [auroraData, setAuroraData] = useState({});

  // æ¨¡æ“¬æ¥µå…‰æ•¸æ“šç”Ÿæˆå™¨
  const checkAurora = (dayId, location) => {
    // æ¨¡æ“¬ API è«‹æ±‚å»¶é²
    setAuroraData(prev => ({ ...prev, [dayId]: { loading: true } }));
    
    setTimeout(() => {
      // éš¨æ©Ÿç”Ÿæˆ KP å€¼ (0-9) å’Œé›²å±¤è¦†è“‹ç‡ (0-100%)
      const kp = (Math.random() * 5 + 2).toFixed(1); // æ¨¡æ“¬ 2.0 åˆ° 7.0 ä¹‹é–“
      const cloud = Math.floor(Math.random() * 60); // æ¨¡æ“¬ 0-60% é›²å±¤
      
      let chance = 'ä½';
      let color = 'text-gray-500';
      if (kp > 4 && cloud < 30) {
        chance = 'æ¥µé«˜! (High)';
        color = 'text-green-600';
      } else if (kp > 3 && cloud < 50) {
        chance = 'ä¸­ç­‰ (Moderate)';
        color = 'text-yellow-600';
      } else {
        chance = 'è¼ƒä½ (Low)';
        color = 'text-gray-500';
      }

      setAuroraData(prev => ({
        ...prev,
        [dayId]: {
          loading: false,
          kp,
          cloud,
          chance,
          color,
          timestamp: new Date().toLocaleTimeString()
        }
      }));
    }, 1500);
  };

  // è¡Œç¨‹è³‡æ–™ (æ ¹æ“šæä¾›çš„ Markdown æ•´ç†)
  const itinerary = [
    {
      day: 1,
      date: "01/02",
      title: "æ¡ƒåœ’ â” ä¸Šæµ·æµ¦æ±",
      location: "ä¸Šæµ·",
      coords: [31.2304, 121.4737],
      desc: "æ­ä¹˜å‰ç¥¥èˆªç©ºç¶“ä¸Šæµ·è½‰æ©Ÿã€‚å…¥ä½ä¸‰ç”²æ¸¯ç»¿åœ°é“‚æ´¾é…’åº—ã€‚",
      tags: ["è½‰æ©Ÿ", "ä¸Šæµ·"],
      hotel: "ä¸‰ç”²æ¸¯ç»¿åœ°é“‚æ´¾é…’åº—"
    },
    {
      day: 2,
      date: "01/03",
      title: "ä¸Šæµ· â” èµ«çˆ¾è¾›åŸº (å¸‚å€è§€å…‰)",
      location: "èµ«çˆ¾è¾›åŸº",
      coords: [60.1699, 24.9384],
      desc: "æŠµé”èµ«çˆ¾è¾›åŸºã€‚åƒè§€å¤§æ•™å ‚ã€è­°æœƒå»£å ´ã€å²©çŸ³æ•™å ‚ã€è¥¿è²æµå£«å…¬åœ’ã€‚",
      tags: ["å¸‚å€è§€å…‰", "å²©çŸ³æ•™å ‚"],
      hotel: "Scandic Aviapolis"
    },
    {
      day: 3,
      date: "01/04",
      title: "èµ«çˆ¾è¾›åŸº â” åº«å¥§çš®å¥§",
      location: "åº«å¥§çš®å¥§",
      coords: [62.8924, 27.6770],
      desc: "å‰å¾€èŠ¬è˜­æ¹–å€åº«å¥§çš®å¥§ï¼Œåƒè§€æ™®å¹½è§€å…‰å¡” (Puijo Tower) ä¿¯ç°æ¹–æ™¯ã€‚",
      tags: ["æ¹–å€", "è§€å…‰å¡”"],
      hotel: "Scandic Atlas"
    },
    {
      day: 4,
      date: "01/05",
      title: "åº«å¥§çš®å¥§ â” å‡±ç±³ (æ¥µå…‰ç¬¬ä¸€å¤œ)",
      location: "å‡±ç±³",
      coords: [65.7350, 24.5685],
      desc: "ç¶“å¥§ç›§æ¹–å‰å¾€æµ·æ¿±é›ªåŸå‡±ç±³ï¼Œåƒè§€ç²‰ç´…è‰²çš„å‡±ç±³æ•™å ‚ã€‚ä»Šæ™šç‚ºæ¥µå…‰è§€æ¸¬ç¬¬ä¸€å¤œï¼ˆé£¯åº—è‡ªè¡Œè§€æ¸¬ï¼‰ã€‚",
      tags: ["æ¥µå…‰", "é›ªåŸ", "å‡±ç±³æ•™å ‚"],
      hotel: "Scandic Kemi",
      hasAurora: true
    },
    {
      day: 5,
      date: "01/06",
      title: "å‡±ç±³ â” ç¾…ç“¦æ¶…ç±³ â” ç›§å¡ (æ¥µå…‰ç¬¬äºŒå¤œ)",
      location: "ç¾…ç“¦æ¶…ç±³/ç›§å¡",
      coords: [66.5039, 25.7294], // Rovaniemi åæ¨™
      desc: "é€ è¨ªè–èª•è€äººæ‘ï¼Œè·¨è¶ŠåŒ—ç·¯66.5åº¦æ¥µåœˆç·šï¼Œé«”é©—é¦´é¹¿é›ªæ©‡ã€‚æ™šä¸Šå®‰æ’è¿½é€æ¥µå…‰ä¹‹æ—…ï¼ˆæ¥µå…‰çµäººï¼‰ã€‚",
      tags: ["è–èª•è€äººæ‘", "é¦´é¹¿é›ªæ©‡", "æ¥µå…‰è¿½é€", "åŒ—æ¥µåœˆ"],
      hotel: "Scandic Rukahovi",
      hasAurora: true
    },
    {
      day: 6,
      date: "01/07",
      title: "ç›§å¡ â” æ‹‰åŠªé˜¿å‹•ç‰©åœ’ â” å‡±ç±³ (æ¥µå…‰ç¬¬ä¸‰å¤œ)",
      location: "æ‹‰åŠªé˜¿/å‡±ç±³",
      coords: [65.9284, 26.5173], // Ranua åæ¨™
      desc: "åƒè§€æ‹‰åŠªé˜¿æ¥µåœ°é‡ç”Ÿå‹•ç‰©åœ’ï¼Œè§€çœ‹åŒ—æ¥µç†Šã€åŒ—æ¥µç‹ç­‰æ¥µåœ°å‹•ç‰©ã€‚è¿”å›å‡±ç±³ã€‚",
      tags: ["æ¥µåœ°å‹•ç‰©åœ’", "åŒ—æ¥µç†Š", "æ¥µå…‰"],
      hotel: "Scandic Kemi",
      hasAurora: true
    },
    {
      day: 7,
      date: "01/08",
      title: "å‡±ç±³ â” å¥§ç›§ â” äºéŸ‹æ–¯å±ˆèŠ",
      location: "å¥§ç›§/äºéŸ‹æ–¯å±ˆèŠ",
      coords: [65.0121, 25.4651], // Oulu åæ¨™
      desc: "å‰å¾€å¥§ç›§åƒè§€èƒ–è­¦å¯Ÿé›•åƒã€é›†å¸‚å¤§å»³ã€‚æ¥è‘—å‰å¾€å¤§å­¸åŸäºéŸ‹æ–¯å±ˆèŠã€‚",
      tags: ["èƒ–è­¦å¯Ÿé›•åƒ", "é›†å¸‚å¤§å»³"],
      hotel: "Scandic Jyvaskyla City"
    },
    {
      day: 8,
      date: "01/09",
      title: "äºéŸ‹æ–¯å±ˆèŠ â” åœ–çˆ¾åº« â” èµ«çˆ¾è¾›åŸº",
      location: "åœ–çˆ¾åº«/èµ«çˆ¾è¾›åŸº",
      coords: [60.4518, 22.2666], // Turku åæ¨™
      desc: "å‰å¾€èŠ¬è˜­å¤éƒ½åœ–çˆ¾åº«ï¼Œæ¬£è³å¥§æ‹‰æ²³ç•”é¢¨å…‰ï¼Œæœ€å¾Œè¿”å›èµ«çˆ¾è¾›åŸºã€‚",
      tags: ["å¤éƒ½", "å¥§æ‹‰æ²³"],
      hotel: "Scandic Kallio"
    },
    {
      day: 9,
      date: "01/10",
      title: "èµ«çˆ¾è¾›åŸº â” ä¸Šæµ·",
      location: "èµ«çˆ¾è¾›åŸº",
      coords: [60.1699, 24.9384],
      desc: "æ•´ç†è¡Œå›Šï¼Œæ»¿è¼‰å›æ†¶å‰å¾€æ©Ÿå ´è¾¦ç†ç™»æ©Ÿï¼Œç¶“ä¸Šæµ·è½‰æ©Ÿè¿”å›ã€‚",
      tags: ["è¿”ç¨‹", "è³¼ç‰©"],
      hotel: "æ©Ÿä¸Š"
    },
    {
      day: 10,
      date: "01/11",
      title: "ä¸Šæµ· â” æ¡ƒåœ’",
      location: "æ¡ƒåœ’",
      coords: [25.0797, 121.2342],
      desc: "æŠµé”æº«æš–çš„å®¶ã€‚",
      tags: ["æŠµé”"],
      hotel: "æº«æš–çš„å®¶"
    }
  ];

  // è³¼ç‰©èˆ‡ç¾é£Ÿæ¨è–¦
  const recommendations = {
    shopping: [
      { name: "Fazer å·§å…‹åŠ›", desc: "èŠ¬è˜­åœ‹æ°‘å·§å…‹åŠ›ï¼Œè—è‰²åŒ…è£çš„ç‰›å¥¶å·§å…‹åŠ›æœ€ç¶“å…¸ï¼Œé©åˆç•¶ä¼´æ‰‹ç¦®ã€‚", icon: "ğŸ«" },
      { name: "Marimekko", desc: "èŠ¬è˜­åœ‹å¯¶ç´šè¨­è¨ˆå“ç‰Œï¼Œä»¥ç½Œç²ŸèŠ±åœ–æ¡ˆèåï¼Œè²©å”®æœé£¾ã€åŒ…åŒ…èˆ‡å®¶å±…ç”¨å“ã€‚", icon: "ğŸŒº" },
      { name: "Iittala", desc: "åŒ—æ­ç»ç’ƒè¨­è¨ˆå·¥è—ä»£è¡¨ï¼ŒAalto èŠ±ç“¶æ˜¯ç¶“å…¸ä¸­çš„ç¶“å…¸ã€‚", icon: "ğŸ¥ƒ" },
      { name: "Moomin (åš•åš•ç±³)", desc: "èŠ¬è˜­æœ€è‘—åçš„å¡é€šäººç‰©ï¼Œå‘¨é‚Šå•†å“éš¨è™•å¯è¦‹ï¼Œå°ˆè³£åº—å€¼å¾—ä¸€é€›ã€‚", icon: "ğŸ¦›" },
      { name: "Marttiini åˆ€å…·", desc: "å‚³çµ±èŠ¬è˜­åˆ€ï¼Œé©åˆæˆ¶å¤–æ´»å‹•æ„›å¥½è€…ï¼ˆ**è«‹å‹™å¿…è¨—é‹**ï¼‰ã€‚", icon: "ğŸ”ª" },
      { name: "Kuksa æœ¨æ¯", desc: "è–©ç±³äººå‚³çµ±æ¨ºæœ¨è£½æˆçš„æ¯å­ï¼Œé€ å‹åœ“æ½¤æº«æš–ã€‚", icon: "â˜•" }
    ],
    food: [
      { name: "Lohikeitto (é®­é­šæ¹¯)", desc: "åŠ å…¥å¤§é‡å¥¶æ²¹ã€è’”è˜¿å’Œé¦¬éˆ´è–¯çš„æ¿ƒéƒé®­é­šæ¹¯ï¼Œæš–èƒƒé¦–é¸ã€‚", icon: "ğŸ²" },
      { name: "PoronkÃ¤ristys (é¦´é¹¿è‚‰)", desc: "æ‹‰æ™®è˜­ç‰¹è‰²èœï¼Œè–„åˆ‡é¦´é¹¿è‚‰ç¶“ç‡‰ç…®ï¼Œæ­é…é¦¬éˆ´è–¯æ³¥èˆ‡è¶Šæ©˜é†¬ã€‚", icon: "ğŸ¦Œ" },
      { name: "Karjalanpiirakka", desc: "å¡ç´¯åˆ©é˜¿æ´¾ï¼Œé»‘éº¥é¤…çš®åŒ…è‘—ç±³ç²¥ï¼Œé€šå¸¸æœƒåœ¨ä¸Šé¢æŠ¹è›‹é»ƒå¥¶æ²¹é†¬ã€‚", icon: "ğŸ¥" },
      { name: "Salmiakki", desc: "é¹¹ç”˜è‰ç³–ï¼ŒèŠ¬è˜­äººçš„æ‘¯æ„›ï¼Œå‘³é“ç¨ç‰¹ï¼ˆåƒå…«è§’åŠ é¹½ï¼‰ï¼Œå‹‡è€…å¿…è©¦ã€‚", icon: "ğŸ¬" },
      { name: "Korvapuusti", desc: "èŠ¬è˜­è‚‰æ¡‚æ²ï¼Œé€ å‹ç‰¹åˆ¥ï¼Œé¦™æ°£æ¿ƒéƒï¼Œæ­é…å’–å•¡çµ•é…ã€‚", icon: "ğŸ¥¯" }
    ]
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* Header */}
      <header className="bg-gradient-to-r from-blue-900 to-slate-800 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <div>
            <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
              <Snowflake className="text-blue-300" /> ç©ç¾èŠ¬è˜­ï¼æ¥µå…‰åæ—¥éŠ
            </h1>
            <p className="text-xs md:text-sm text-blue-200 mt-1">2026/01/02 - 01/11 | èµ«çˆ¾è¾›åŸºï¼è–èª•è€äººæ‘ï¼æ¥µå…‰</p>
          </div>
          <nav className="hidden md:flex gap-4 text-sm font-medium">
            <button 
              onClick={() => setActiveTab('itinerary')}
              className={`px-3 py-1 rounded-full transition ${activeTab === 'itinerary' ? 'bg-white text-blue-900' : 'hover:bg-blue-800'}`}
            >
              è¡Œç¨‹åœ°åœ–
            </button>
            <button 
              onClick={() => setActiveTab('guide')}
              className={`px-3 py-1 rounded-full transition ${activeTab === 'guide' ? 'bg-white text-blue-900' : 'hover:bg-blue-800'}`}
            >
              è³¼ç‰©ç¾é£Ÿ
            </button>
            <button 
              onClick={() => setActiveTab('info')}
              className={`px-3 py-1 rounded-full transition ${activeTab === 'info' ? 'bg-white text-blue-900' : 'hover:bg-blue-800'}`}
            >
              æ—…éŠé ˆçŸ¥
            </button>
          </nav>
        </div>
        {/* Mobile Nav */}
        <div className="flex md:hidden justify-around mt-3 border-t border-blue-700 pt-2 text-xs">
           <button onClick={() => setActiveTab('itinerary')} className={activeTab === 'itinerary' ? 'text-white font-bold' : 'text-blue-300'}>è¡Œç¨‹</button>
           <button onClick={() => setActiveTab('guide')} className={activeTab === 'guide' ? 'text-white font-bold' : 'text-blue-300'}>è³¼ç‰©ç¾é£Ÿ</button>
           <button onClick={() => setActiveTab('info')} className={activeTab === 'info' ? 'text-white font-bold' : 'text-blue-300'}>é ˆçŸ¥</button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4">
        {activeTab === 'itinerary' && (
          <div className="space-y-6">
            {/* Map Placeholder */}
            <div className="bg-white rounded-xl shadow-md overflow-hidden border border-slate-200">
               <div className="bg-slate-100 p-2 border-b text-xs text-center text-slate-500 flex items-center justify-center gap-2">
                 <Map size={14} /> è¡Œç¨‹åœ°åœ– (è«‹è¦‹ä¸‹æ–¹è©³ç´°åœ°åœ–å€å¡Š)
               </div>
               <div id="map-container" className="h-64 md:h-96 w-full z-0 bg-blue-50 relative">
                  <div className="absolute inset-0 flex items-center justify-center text-slate-400 pointer-events-none">
                    åœ°åœ–è¼‰å…¥ä¸­...
                  </div>
               </div>
            </div>

            {/* Timeline */}
            <div className="space-y-4">
              {itinerary.map((day) => (
                <div 
                  key={day.day} 
                  id={`day-${day.day}`}
                  className={`bg-white rounded-xl shadow-sm border transition-all duration-300 ${selectedDay === day.day ? 'border-blue-400 ring-2 ring-blue-100' : 'border-slate-100 hover:border-blue-200'}`}
                  onClick={() => setSelectedDay(day.day)}
                >
                  <div className="p-4">
                    <div className="flex justify-between items-start">
                      <div className="flex gap-3">
                        <div className="flex flex-col items-center min-w-[3.5rem]">
                          <span className="text-xs font-bold text-blue-600 uppercase">Day</span>
                          <span className="text-2xl font-black text-slate-800 leading-none">{day.day}</span>
                          <span className="text-xs text-slate-400 mt-1">{day.date}</span>
                        </div>
                        <div>
                          <h3 className="text-lg font-bold text-slate-800">{day.title}</h3>
                          <div className="flex flex-wrap gap-2 mt-2">
                            {day.tags.map(tag => (
                              <span key={tag} className="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-full">#{tag}</span>
                            ))}
                          </div>
                        </div>
                      </div>
                      {day.hasAurora && (
                        <div className="bg-purple-900 text-white p-1.5 rounded-full shadow-lg animate-pulse" title="æ¥µå…‰è§€æ¸¬æ©Ÿæœƒ">
                          <Navigation size={16} className="text-green-300" />
                        </div>
                      )}
                    </div>

                    <div className={`mt-4 text-slate-600 text-sm leading-relaxed ${selectedDay === day.day ? 'block' : 'hidden md:block'}`}>
                      <p>{day.desc}</p>
                      <div className="mt-3 flex items-center gap-2 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                        <MapPin size={14} /> ä½å®¿: <span className="font-semibold">{day.hotel}</span>
                      </div>
                    </div>

                    {/* Aurora Monitor Widget */}
                    {day.hasAurora && (selectedDay === day.day || window.innerWidth >= 768) && (
                      <div className="mt-4 border-t border-dashed border-slate-200 pt-4">
                        <div className="bg-gradient-to-br from-slate-900 to-purple-900 rounded-lg p-4 text-white overflow-hidden relative">
                          <div className="absolute top-0 right-0 p-2 opacity-20">
                            <Snowflake size={60} />
                          </div>
                          <h4 className="font-bold flex items-center gap-2 mb-2 text-green-300">
                            <Navigation size={18} /> æ¥µå…‰è§€æ¸¬ç«™: {day.location}
                          </h4>
                          
                          {!auroraData[day.day] ? (
                            <button 
                              onClick={(e) => { e.stopPropagation(); checkAurora(day.day, day.location); }}
                              className="w-full bg-white/10 hover:bg-white/20 text-white py-2 px-4 rounded border border-white/20 transition flex items-center justify-center gap-2 text-sm font-medium"
                            >
                              <Camera size={16} /> æª¢æ¸¬å³æ™‚æ¥µå…‰æ©Ÿç‡
                            </button>
                          ) : auroraData[day.day].loading ? (
                            <div className="flex items-center justify-center gap-3 py-2 text-sm text-blue-200">
                              <div className="animate-spin rounded-full h-4 w-4 border-2 border-green-400 border-t-transparent"></div>
                              æ­£åœ¨åˆ†æç£å ´æ•¸æ“š...
                            </div>
                          ) : (
                            <div className="space-y-3 animate-in fade-in duration-500">
                              <div className="flex justify-between items-end">
                                <div>
                                  <div className="text-xs text-slate-400">KP æŒ‡æ•¸ (0-9)</div>
                                  <div className="text-2xl font-bold text-green-400">{auroraData[day.day].kp}</div>
                                </div>
                                <div>
                                  <div className="text-xs text-slate-400">é›²å±¤è¦†è“‹</div>
                                  <div className="text-2xl font-bold text-blue-300">{auroraData[day.day].cloud}%</div>
                                </div>
                                <div className="text-right">
                                  <div className="text-xs text-slate-400">å¯è¦‹æ©Ÿç‡</div>
                                  <div className={`text-xl font-bold ${auroraData[day.day].color}`}>{auroraData[day.day].chance}</div>
                                </div>
                              </div>
                              <div className="text-[10px] text-slate-500 text-center border-t border-white/10 pt-2">
                                æ•¸æ“šæ›´æ–°æ™‚é–“: {auroraData[day.day].timestamp} (æ¨¡æ“¬æ•¸æ“š)
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'guide' && (
          <div className="space-y-8 animate-in slide-in-from-right duration-300">
            {/* Shopping Section */}
            <section>
              <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-2 border-blue-200">
                <ShoppingBag className="text-blue-600" /> å¿…è²·è³¼ç‰©æ¨è–¦
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {recommendations.shopping.map((item, idx) => (
                  <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex gap-4 items-start">
                    <div className="text-3xl bg-blue-50 w-12 h-12 flex items-center justify-center rounded-full shrink-0">
                      {item.icon}
                    </div>
                    <div>
                      <h3 className="font-bold text-slate-800">{item.name}</h3>
                      <p className="text-sm text-slate-600 mt-1">{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Food Section */}
            <section>
              <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-2 border-blue-200">
                <Utensils className="text-blue-600" /> å¿…åƒç¾é£Ÿæ¸…å–®
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {recommendations.food.map((item, idx) => (
                  <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex gap-4 items-start">
                    <div className="text-3xl bg-orange-50 w-12 h-12 flex items-center justify-center rounded-full shrink-0">
                      {item.icon}
                    </div>
                    <div>
                      <h3 className="font-bold text-slate-800">{item.name}</h3>
                      <p className="text-sm text-slate-600 mt-1">{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          </div>
        )}

        {activeTab === 'info' && (
          <div className="space-y-6 animate-in slide-in-from-right duration-300">
            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-5">
              <h3 className="font-bold text-yellow-800 flex items-center gap-2 mb-3">
                <Info size={20} /> è²¼å¿ƒå°æé†’
              </h3>
              <ul className="space-y-2 text-sm text-yellow-900">
                <li className="flex items-start gap-2"><Check size={14} className="mt-1" /> å¹³å‡æ°£æº« -7 ~ -1 åº¦ï¼Œè«‹å‚™å¦¥ã€Œæ´‹è”¥å¼ç©¿æ­ã€ã€‚</li>
                <li className="flex items-start gap-2"><Check size={14} className="mt-1" /> èŠ¬è˜­é›»å£“ 220-240Vï¼Œé›™åœ“å­”æ’é ­ã€‚</li>
                <li className="flex items-start gap-2"><Check size={14} className="mt-1" /> æ™‚å·®æ…¢å°ç£ 6 å°æ™‚ã€‚</li>
                <li className="flex items-start gap-2"><Check size={14} className="mt-1" /> é‹°é›»æ± ã€è¡Œå‹•é›»æºå‹™å¿…æ”¾åœ¨æ‰‹æè¡Œæï¼Œä¸å¯è¨—é‹ã€‚</li>
              </ul>
            </div>

            <div className="bg-white border border-slate-200 rounded-xl p-5">
              <h3 className="font-bold text-slate-800 mb-3">å‡ºåœ‹æ”œå¸¶ç‰©å“æ ¸å°</h3>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-slate-600">
                {[
                  "è­·ç…§ã€ç°½è­‰", "è¡Œå‹•é›»æº (æ‰‹æ)", "å€‹äººå¸¸å‚™è—¥", "ä¿¡ç”¨å¡/æ­å…ƒ", 
                  "ç‰™åˆ·ç‰™è† (é£¯åº—ç„¡)", "æ‹–é‹ (é£¯åº—ç„¡)", "ä¿æš–å¸½/åœå·¾/æ‰‹å¥—", 
                  "é˜²æ»‘é‹/é›ªé´", "æ³³è¡£ (æ¡‘æ‹¿ç”¨)", "è½‰æ›æ’é ­ (é›™åœ“å­”)"
                ].map((item, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <div className="w-4 h-4 border rounded border-slate-300"></div> {item}
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </main>

      {/* Initialize Map Effect */}
      <MapInitializer itinerary={itinerary} activeTab={activeTab} />
    </div>
  );
};

// Separate component to handle Leaflet logic
const MapInitializer = ({ itinerary, activeTab }) => {
  const mapInstanceRef = useRef(null);
  const [leafletReady, setLeafletReady] = useState(false);

  useEffect(() => {
    // 1. Check if Leaflet CSS is already present
    if (!document.querySelector('link[href*="leaflet"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
    }

    // 2. Check if Leaflet JS is present
    if (window.L && window.L.map) {
      setLeafletReady(true);
    } else {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.async = true;
      script.onload = () => setLeafletReady(true);
      document.head.appendChild(script);
    }
  }, []);

  useEffect(() => {
    if (activeTab !== 'itinerary' || !leafletReady) return;

    // Safety check for container
    const container = document.getElementById('map-container');
    if (!container) return;

    // Check if map is already initialized
    if (mapInstanceRef.current) {
        // Map exists, just invalidate size to handle tab switching
        setTimeout(() => mapInstanceRef.current.invalidateSize(), 100);
        return;
    }

    try {
        // Init Map centered on Finland
        const map = window.L.map('map-container').setView([64.5, 26.0], 5);
        
        window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add Markers and Polyline
        const latlngs = [];
        
        itinerary.forEach((point) => {
            if (point.location !== "ä¸Šæµ·" && point.location !== "æ¡ƒåœ’" && point.location !== "æ©Ÿä¸Š") {
                const marker = window.L.marker(point.coords).addTo(map);
                marker.bindPopup(`<b>Day ${point.day}: ${point.location}</b><br>${point.title}`);
                latlngs.push(point.coords);
            }
        });

        // Draw line
        if (latlngs.length > 0) {
              const polyline = window.L.polyline(latlngs, {color: 'red', weight: 3, opacity: 0.7, dashArray: '5, 10'}).addTo(map);
              map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }
        
        mapInstanceRef.current = map;
    } catch (err) {
        console.error("Map initialization failed:", err);
    }

  }, [activeTab, itinerary, leafletReady]);

  return null;
};

export default FinlandTripApp;